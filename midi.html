<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MIDI Input Test</title>
  <script src="midi.js"></script>
  <style>
    #code-text-area {
      width: 500px;
      height: 500px;
    }
  </style>
</head>
<body onload="initialize()">
  <input type="file" id="file-input">
  <h1>MIDI Input Test</h1>
  <p>Connect your MIDI device and press some keys:</p>
  <ul id="midi-input"></ul>
  <textarea id="code-text-area">
l()
let dataView = new DataView(a);
const META_EVENT = 0xFF;
const SYS_EX_EVENT = 0xF0;

function getString(dataView, offset, length) {
    let string = "";
    for (let i = 0; i < length; i++) {
        string += String.fromCharCode(dataView.getInt8(offset + i));
    }
    return string;
}

let header = getString(dataView, 0, 4);

let length = dataView.getUint32(4);

let fileFormat = dataView.getUint16(8);
let numTracks = dataView.getUint16(10);
let timeDivision = dataView.getUint16(12);


let trackHeader = getString(dataView, 14, 4);


let trackLength = dataView.getUint32(18);


// Tries to parse a variable length value in dataView from the offset
function getDeltaTime(dataView, offset) {
    let delta = 0
    let length = 0;
    while (true) {
        let deltaByte = dataView.getUint8(offset + length)
        length++;
        delta = (delta << 7) | (deltaByte & 0x7F);
        if ((deltaByte & 0x80) === 0) break;
    } 

    return [delta, length]
}

function isNoteOnEvent(eventType) {
    return (eventType & 0xF0) === 0x90;
}
function isNoteOffEvent(eventType) {
    return (eventType & 0xF0) === 0x80;
}
function isControlChangeEvent(eventType) {
    return (eventType & 0xF0) === 0xB0;
}
function isProgramChangeEvent(eventType) {
    return (eventType & 0xF0) === 0xC0;
}
function isSystemExclusiveEvent(eventType) {
    return (eventType & 0xFF) === 0xF0;
}
function isMetaEvent(eventType) {
    return eventType === 0xFF;
}

function getMetaEventType(dataView, offset) {
    return dataView.getUint8(offset);
}

function parseTrackEvent(dataView, offset) {
    let eventType = dataView.getUint8(offset);
    if (isNoteOnEvent(eventType)) {
        l(offset, "Note On");
        return offset + 3;
    } else if (isNoteOffEvent(eventType)) {
        l(offset, "Note Off");
        return offset + 3;        
    } else if (isControlChangeEvent(eventType)) {
        l(offset, "Control Change");
        return offset + 3;
    } else if (isProgramChangeEvent(eventType)) {
        l(offset, "Program Change");
        return offset + 2;
    } else if (isSystemExclusiveEvent(eventType)) {
        l(offset, "System Exclusive");
        return offset + 1;
    } else if (isMetaEvent(eventType)) {
        let metaEventType = dataView.getUint8(offset + 1)
        let length = dataView.getUint8(offset + 2);
        l(offset, "Meta Event", "0x"+metaEventType.toString(16), length);
        for (let i = 0; i < length; ++i) {
            let val = dataView.getUint8(offset + 3 + i);
            l(val)
        }
        return offset + 3 + length + 1; // I do not understand why the + 1
    } else {
        l(offset, "Unknown Event: 0x" + eventType.toString(16));
        return offset + 1;
    }
}

let [vTime, vTimeLength] = getDeltaTime(dataView, 22)
l(trackLength)



return 
let offset = 23 + trackLength;
let i = 0;
while(i < 5) {
    i++;
    offset = parseTrackEvent(dataView, offset);
}

// Start of next track
l(getString(dataView, 22 + trackLength, 4));


  </textarea>
</body>
</html>

